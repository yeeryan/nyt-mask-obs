---
title: "NYC COVID 19 Rates & Observed Mask Usage"
author: "Ryan Yee"
date: "11/11/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggfortify)
library(plotly)
library(dplyr)

setwd("~/Projects/nyt-mask-obs/")

#source("R/import.R")
source("setup.R")
source("R/unified_plot.R")


#Merge NYC Health Data and NYT Mask Observations
nyc.covid19.mask <- inner_join(nyc.covid19.data, nyt.data, by="zip") %>% 
  mutate(PERCENT_POSITIVE = PERCENT_POSITIVE/100)
# %>% 
  # mutate(obs_mask = scales::percent(obs_mask)) %>% 
  # mutate(women_mask = scales::percent(women_mask)) %>% 
  # mutate(men_mask = scales::percent(men_mask))

#Filter Data Function
date_covid19.mask <- function(day) {
  nyc.covid19.mask %>% filter(date == day)
}

data_0713 <- date_covid19.mask("2020-07-13")
data_0720 <- date_covid19.mask("2020-07-20")
data_0727 <- date_covid19.mask("2020-07-27")
data_0803 <- date_covid19.mask("2020-08-03")
data_0810 <- date_covid19.mask("2020-08-10")


```

<div style= "float:right;position: relative; top: -80px; padding:10px">

```{r Map, echo=FALSE, results='HIDE', warning=FALSE}
unified.plot
```
Toggle between layers to view COVID 19 rates from NYC Health and observed mask usage by the New York Times. 

Click on an area for more info.

</div>

<p style="font-size:10px">
#### NYC Health (Dates)

Using data from NYC Health, these layers map out city-wide COVID 19 Rates per 100,000 People in each ZCTA. This map includes weekly rates from July 13 to August 10, 2020. Mouseover of ZCTA shows area name, borough, ZCTA, and case rate as designated by NYC Health.

#### New York Times Mask Observations (NYT Obs)

Using data from the New York Times article "Are New Yorkers Wearing Masks?", this layer maps out observed mask usage rates by the Times' reporters between July 27 to July 30, 2020. The additional NYT Obs layers shows observed mask usage rates based on perceived gender. The ZCTAs where the intersections of the Times reporters were used to map out observed mask usage rates and to compare NYC Health data with. Mouseover of the ZCTA shows area name, borough, and intersection of observation as reported by the Times. ZCTAs were found by me. 

Link to article:
https://www.nytimes.com/2020/08/20/nyregion/nyc-face-masks.html
</p>


```{r COVID19 Case Rate Graph, echo=FALSE, results='HIDE', warning=FALSE}
plot_ly(nyc.covid19.mask,
        x = ~date,
        y = ~COVID_CASE_RATE,
        color = ~area,
        mode = 'lines+markers') %>% 
  layout(
    title = 'COVID 19 Case Rate per 100,000',
    showlegend = TRUE,
    yaxis = list(title = "COVID 19 Case Rate"),
    xaxis = list(title = "Date")
)

```

```{r COVID19 Mask Observations, echo=FALSE, results='HIDE', warning=FALSE}
plot_ly(nyt.data,
        x = ~area,
        y = ~obs_mask,
        color = ~area,
        mode = 'bar'
)
```

```{r COVID19 Mask Observations and Percent Positive, echo=FALSE, results='HIDE', warning=FALSE}
plot_ly(nyt.data,
        x = ~area,
        y = ~obs_mask,
        type = 'scatter',
        mode = 'markers',
        name = 'Mask Rate',
        visible = T) %>% 
  add_trace(data_0713, y = data_0713$PERCENT_POSITIVE, name = 'July 13', visible = T) %>% 
  add_trace(data_0720, y = data_0720$PERCENT_POSITIVE, name = 'July 20', visible = T) %>% 
  add_trace(data_0727, y = data_0727$PERCENT_POSITIVE, name = 'July 27', visible = T) %>% 
  add_trace(data_0803, y = data_0803$PERCENT_POSITIVE, name = 'August 3', visible = T) %>% 
  add_trace(data_0810, y = data_0810$PERCENT_POSITIVE, name = 'August 10', visible = T) %>% 
  layout(
    title = 'Observed Mask Rates & COVID 19 Positive Rates by Area',
    showlegend = TRUE,
    yaxis = list(title = "% of Masks Observed/COVID 19 Positive Rate",tickformat = "%"),
    xaxis = list(title = "Area"),
    hovermode = 'compare'
)
```

# Analysis

```{r table of average change}
nyc.avg.caserate <- nyc.covid19.mask %>% 
  select("zip", "date","area", "COVID_CASE_RATE") %>% 
  dplyr::group_by(zip) %>% 
  dplyr::arrange(zip, date) %>% 
  mutate(rate = (COVID_CASE_RATE - lag(COVID_CASE_RATE))/lag(COVID_CASE_RATE)) %>% 
  summarise(avg_rate = mean(rate, na.rm = TRUE))

nyc.avg.rate.mask <- left_join(nyt.data, nyc.avg.caserate, by ="zip") %>% 
  mutate(obs_mask = 1 - obs_mask)

```

```{r chart}
plot_ly(nyc.avg.rate.mask,
        x = ~area,
        y = ~obs_mask,
        type = 'scatter',
        mode = 'markers',
        name = 'Mask Rate',
        visible = T) %>% 
  add_trace(nyc.avg.rate.mask, y = ~avg_rate, name = 'Avg. Change Rate', visible = T) %>% 
  layout(
    title = 'Observed Mask Rates & COVID 19 Positive Rates by Area',
    showlegend = TRUE,
    yaxis = list(title = "% of Masks Observed/COVID 19 Positive Rate",tickformat = "%"),
    xaxis = list(title = "Area"),
    hovermode = 'compare'
)


```

```{r}
avg_rate.mask_model <- lm(formula = avg_rate ~ obs_mask, data = nyc.avg.rate.mask)

summary(avg_rate.mask_model)

```
